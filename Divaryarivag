<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§ - ÛŒÚ© ÙØ§ÛŒÙ„</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:sans-serif;max-width:900px;margin:18px auto;padding:12px}
  h1{margin-bottom:6px}
  button{padding:8px 12px;margin:6px 4px;cursor:pointer}
  input,textarea{width:100%;padding:8px;margin:6px 0;box-sizing:border-box}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .card{border:1px solid #e0e0e0;border-radius:8px;padding:10px;margin:10px 0;background:#fafafa}
  img.thumb{width:120px;height:auto;border-radius:6px;margin:4px}
  .muted{color:#666;font-size:13px}
  .progress{height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:6px}
  .bar{height:100%;background:#4caf50;width:0%}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>

<h1>Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§ â€” Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡</h1>
<p class="muted">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ: Ø­Ø¯Ø§Ú©Ø«Ø± Û³ Ø¹Ú©Ø³ØŒ Ù‚ÛŒÙ…Øª Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª</p>

<div id="controls" class="card">
  <div class="flex-between">
    <div>
      <button id="btnShowForm">ğŸ“Œ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
      <button id="btnShowList">ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</button>
    </div>
    <div class="muted">ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÛŒ Ú©ÙˆÚ†Ú© Ùˆ Ù…Ø­Ù„ÛŒ</div>
  </div>
</div>

<div id="formArea" class="card" style="display:none">
  <h3>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯</h3>

  <label>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</label>
  <input id="price" type="number" placeholder="Ù…Ø«Ø§Ù„: 120000">

  <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
  <textarea id="desc" rows="4" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¢Ú¯Ù‡ÛŒ..."></textarea>

  <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³â€ŒÙ‡Ø§ (Ø­Ø¯Ø§Ú©Ø«Ø± 3)</label>
  <input id="files" type="file" accept="image/*" multiple>

  <div id="preview" class="row"></div>

  <div id="uploadProgress" style="display:none;">
    <div class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ±...</div>
    <div class="progress"><div class="bar" id="globalBar"></div></div>
  </div>

  <div style="margin-top:10px;">
    <button id="btnUpload">Ø«Ø¨Øª Ùˆ Ø¢Ù¾Ù„ÙˆØ¯</button>
    <button id="btnCancel">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>

  <p class="muted">Ù†Ú©ØªÙ‡: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±ÙˆÛŒ imgbb Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¯Ø± Firebase Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ù†Ø¯.</p>
</div>

<div id="listArea" class="card" style="display:none">
  <h3>Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h3>
  <div id="adsList"></div>
  <div id="emptyMsg" class="muted"></div>
</div>

<!-- Firebase (Ù†Ø³Ø®Ù‡ 8 Ø³Ø§Ø¯Ù‡) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ========== ØªÙ†Ø¸ÛŒÙ…Ø§Øª: Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø®ÙˆØ¯Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† ========== */
const IMGBB_KEY = "https://i.ibb.co/zVbKXspj/68c0797d2e4b43cec3e90539.jpg";


const firebaseConfig = {
  apiKey: "AIzaSyDrw4BGlqE73KzqfvlffD5njbK_HZWJP0s",
  authDomain: "yarivag-sity.firebaseapp.com",
  projectId: "yarivag-sity",
  storageBucket: "yarivag-sity.firebasestorage.app",
  messagingSenderId: "481949392702",
  appId: "1:481949392702:web:bba54ec37dc19e6db4166f",
  measurementId: "G-WMY8E6WY6F"
};
/* ================================================================== */

/* initialize firebase */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ */
const btnShowForm = document.getElementById('btnShowForm');
const btnShowList = document.getElementById('btnShowList');
const formArea = document.getElementById('formArea');
const listArea = document.getElementById('listArea');
const btnCancel = document.getElementById('btnCancel');
const btnUpload = document.getElementById('btnUpload');
const filesInput = document.getElementById('files');
const preview = document.getElementById('preview');
const adsList = document.getElementById('adsList');
const priceInput = document.getElementById('price');
const descInput = document.getElementById('desc');
const uploadProgress = document.getElementById('uploadProgress');
const globalBar = document.getElementById('globalBar');
const emptyMsg = document.getElementById('emptyMsg');

btnShowForm.onclick = ()=>{ showForm(); }
btnShowList.onclick = ()=>{ showList(); loadAds(); }
btnCancel.onclick = ()=>{ hideAll(); }
filesInput.onchange = renderPreview;
btnUpload.onclick = handleSubmit;

function showForm(){
  formArea.style.display='block';
  listArea.style.display='none';
  preview.innerHTML='';
}
function showList(){
  formArea.style.display='none';
  listArea.style.display='block';
}
function hideAll(){
  formArea.style.display='none';
  listArea.style.display='none';
}

/* Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµØ§ÙˆÛŒØ± */
function renderPreview(){
  preview.innerHTML='';
  const files = Array.from(filesInput.files).slice(0,3);
  files.forEach(f=>{
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url; img.className='thumb';
    preview.appendChild(img);
  });
  if(filesInput.files.length>3){
    alert("Ø­Ø¯Ø§Ú©Ø«Ø± Û³ ØªØµÙˆÛŒØ± Ù…Ø¬Ø§Ø² Ø§Ø³Øª. ØªØµØ§ÙˆÛŒØ± Ø§Ø¶Ø§ÙÙ‡ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.");
  }
}

/* Ø¢Ù¾Ù„ÙˆØ¯ ÛŒÚ© ØªØµÙˆÛŒØ± Ø¨Ù‡ imgbb */
async function uploadToImgbb(file){
  const form = new FormData();
  form.append('image', file);
  // optional: name, expiration
  const url = `https://api.imgbb.com/1/upload?key=${encodeURIComponent(IMGBB_KEY)}`;
  const res = await fetch(url, { method: 'POST', body: form });
  if(!res.ok){
    const txt = await res.text();
    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ imgbb: '+txt);
  }
  const j = await res.json();
  return j.data.url; // direct image url
}

/* Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø¢Ú¯Ù‡ÛŒ */
async function handleSubmit(){
  const price = priceInput.value.trim();
  const desc = descInput.value.trim();
  const filesArr = Array.from(filesInput.files).slice(0,3);

  if(!price || !desc){
    alert("Ù„Ø·ÙØ§Ù‹ Ù‚ÛŒÙ…Øª Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    return;
  }

  // Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯
  uploadProgress.style.display='block';
  globalBar.style.width='0%';

  try{
    const total = filesArr.length || 1;
    const urls = [];
    for(let i=0;i<filesArr.length;i++){
      const file = filesArr[i];
      // Ø¢Ù¾Ù„ÙˆØ¯ Ù‡Ø± Ø¹Ú©Ø³
      const imageUrl = await uploadToImgbb(file);
      urls.push(imageUrl);
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ progress
      const perc = Math.round(((i+1)/total)*100);
      globalBar.style.width = perc + '%';
    }

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¹Ú©Ø³ÛŒ Ù†Ø¨ÙˆØ¯ØŒ urls = []
    const ad = {
      price: price,
      desc: desc,
      images: urls,
      created: Date.now()
    };

    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± firebase (Realtime Database)
    await db.ref('ads').push(ad);

    alert('Ø¢Ú¯Ù‡ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…');
    // Ø±ÛŒØ³Øª ÙØ±Ù…
    priceInput.value=''; descInput.value=''; filesInput.value=''; preview.innerHTML='';

    globalBar.style.width='100%';
    setTimeout(()=>{ uploadProgress.style.display='none'; globalBar.style.width='0%'; }, 700);

    // Ø¨Ø±Ùˆ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§
    showList();
    loadAds();

  }catch(err){
    console.error(err);
    alert('Ø®Ø·Ø§: '+ (err.message || err));
    uploadProgress.style.display='none';
    globalBar.style.width='0%';
  }
}

/* Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ */
function loadAds(){
  adsList.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
  db.ref('ads').orderByChild('created').on('value', snap=>{
    const data = snap.val();
    adsList.innerHTML = '';
    if(!data){
      emptyMsg.textContent = 'Ù‡ÛŒÚ† Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
      return;
    } else {
      emptyMsg.textContent = '';
    }
    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ùˆ Ù…Ø±ØªØ¨ Ø³Ø§Ø²ÛŒ Ù†Ø²ÙˆÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†
    const arr = Object.keys(data).map(k => ({ key:k, ...data[k] }))
                  .sort((a,b)=> b.created - a.created);
    arr.forEach(ad => {
      const card = document.createElement('div');
      card.className = 'card';
      const imgsHtml = (ad.images||[]).map(u => `<img class="thumb" src="${u}" loading="lazy">`).join('');
      card.innerHTML = `
        <div class="row">${imgsHtml}</div>
        <div style="margin-top:6px;"><b>${ad.price} ØªÙˆÙ…Ø§Ù†</b></div>
        <div style="margin-top:6px;">${escapeHtml(ad.desc)}</div>
        <div class="muted" style="margin-top:6px;font-size:12px">${new Date(ad.created).toLocaleString()}</div>
      `;
      adsList.appendChild(card);
    });
  }, err=> {
    console.error(err);
    adsList.innerHTML = '<div class="muted">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</div>';
  });
}

/* Ø§Ù…Ù†â€ŒØ³Ø§Ø²ÛŒ Ù…ØªÙ† Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ (Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡) */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª */
showList();
loadAds();
</script>

</body>
</html>
